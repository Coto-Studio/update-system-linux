---
# tasks file for update-system-linux
- name: Update package manager cache
  become: true
  package:
    update_cache: true
    cache_valid_time: 3600
  register: updaded_packages

- name: Upgrade system packages
  become: true
  apt:
    upgrade: dist
    autoremove: true
    autoclean: true
    cache_valid_time: 3600
  async: 600
  poll: 0
  register: upgrade_async
  when: updaded_packages.changed

- name: Wait for connection to recover after upgrade
  wait_for_connection:
    delay: 15
    timeout: 300
  when: updaded_packages.changed

- name: Check upgrade completed successfully
  async_status:
    jid: "{{ upgrade_async.ansible_job_id }}"
  register: upgrade_result
  until: upgrade_result.finished
  retries: 30
  delay: 10
  become: true
  when: updaded_packages.changed and upgrade_async.ansible_job_id is defined
  ignore_errors: true

- name: Verify system is in clean state
  become: true
  command: dpkg --audit
  register: dpkg_audit
  changed_when: false
  failed_when: dpkg_audit.stdout | length > 0
  when: updaded_packages.changed

- name: Ensure System Packages are installed
  become: true
  package:
    name: "{{ item }}"
    state: present
  loop: "{{ system_install_packages }}"
